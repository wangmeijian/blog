# 二维码的秘密
这是我在公司内部做的第四次技术分享，前面三次分享，都是基于当时手上在做的项目，产生的一些想法或经验总结，这一次也不例外。  

前几次分享的主题分别是：  

1、前端自动化测试实战  
2、提高web可访问性，选择合适的技术做合适的项目  
3、蓝信应用的开发与测试  

本次分享的主题叫：《二维码的秘密》  

<img src="https://github.com/wangmeijian/images/blob/master/erweimademimi/haibao.jpg?raw=true" width="420" align="center" />  

最近在做的项目，需要实现通过App扫码登录，前端利用websocket，监听后端扫码成功的信息来实现登录。在用qrcodejs生成二维码的时候，我产生了一些疑问：  

* 二维码容量有多大？  
* 二维码上面三个大方块是干什么的？  
* 二维码能存储视频/音频吗？  
* 二维码破损了为什么还能被识别？  
* 二维码生成原理是怎样的？  

带着这些疑问，往下看

## 诞生和普及  
上个世纪60年代，日本迎来高速增长期，卖食品、衣服等种类繁多的超市开始在城市中出现，当时超市使用的现金出纳机要靠手动输入商品价格，因此负责现金出纳的人常常会因手腕的麻木和“腱鞘炎”而苦恼。  

<img src="https://github.com/wangmeijian/images/blob/master/erweimademimi/85F2C986-41B6-4604-B4A6-9B7DE4221700.png?raw=true" width="220" align="center" />

条形码的出现解决了这个问题，因此，条形码得以普及，条形码也叫一维码，缺点是，它的容量非常有限，最多能容纳20个英文字符和数字，日本的原昌宏投入了二维码的研发，一年半后，几经曲折，二维码诞生了。

二维码共有40个版本，每个版本有固定的码元数，version 1的码元数为21码元×21码元，version 2的码元数为25码元×25码元，每个版本横向和纵向各自以4码元为单位递增，以此类推

![](https://github.com/wangmeijian/images/blob/master/erweimademimi/32210BE6-7CAA-41E5-A044-81365A2AA168.png?raw=true)  

## 一维码和二维码
二维码翻译成英文为QR Code，全称为Quick Response Code，即快速响应码，原昌宏在研发二维码之初，两个重点，一个是可以容纳大量信息，另一个就是可以快速读取。二维码相较于一维码，其优点显而易见，以下是两者之间的差异  

| 类型 | 差异  
| --- | ---
| 一维码 | 1、容量较小：30个字符左右<br />2、只能包含字母和数字<br />3、尺寸相对较大（空间利用率低）<br />4、遭到破坏后无法读取
| 二维码 | 1、数据容量大<br />2、超越了数字字母的限制<br />3、尺寸相对较小<br />4、被破坏依然可以被读取

## 二维码图形拆解
在继续深入了解二维码之前，先观察二维码图片，了解一些基本概念  

![](https://github.com/wangmeijian/images/blob/master/erweimademimi/F4D01B2C-05F6-46F4-9843-93ACED5D05D5.png?raw=true)  

二维码左上角、右上角以及左下角都有一个回形方块，右下方有一个小的回形方块，他们的作用是什么？剩下的都是一些类似于像素点的黑白方块，他们是怎么来的？

![](https://github.com/wangmeijian/images/blob/master/erweimademimi/B4EF10D9-2290-455B-AF68-0BD2A718DE5C.png?raw=true)  

三个大方块，即位置探测图形，用来标记二维码的大小和方向
定位图形：二维码图形过大时，扫码容易畸形，定位图形就来防止畸形的产生
校正图形：版本2及以上才有
格式信息：包括纠错等级、掩码类别
版本信息：二维码的版本
数据和纠错码字：数据码和纠错码

出现了一些新概念，暂时不理解不要紧，往下看

## 二维码优点
二维码相较于一维码更好的地方，就是它的优点，总结一下二维码的优点：  

1、存储大容量信息  
<img src="https://github.com/wangmeijian/images/blob/master/erweimademimi/6A4DEA53-151C-4347-A9DF-522E796C5C3E.png?raw=true" width="420" align=center />  

一图胜千言，一个小小的二维码，可以存储成百上千个字符，具体容量跟二维码的版本有关  
版本1能存储41个数字或25个英文+数字或10个汉字  
版本40能存储7089个数字或4296个英文+数字或1817个汉字  

2、在小空间内打印  
<img src="https://github.com/wangmeijian/images/blob/master/erweimademimi/824B3DE3-3167-4902-B5D7-5286DB3C7E24.png?raw=true" width="420" align=center />  

相对而言，二维码占用的空间比一维码小得多

3、有效处理各种文字  
<img src="https://github.com/wangmeijian/images/blob/master/erweimademimi/5555EC0E-94FA-4C1D-A881-DBB12A6FC9D0.png?raw=true" width="420" align=center />  

二维码可以存储各种文字，因为最终都是转换成二进制

4、具备纠错能力  
<img src="https://github.com/wangmeijian/images/blob/master/erweimademimi/80D5F719-D87B-4D7B-B5B9-18C4F4D3ED03.png?raw=true" width="420" align=center />  

二维码小部分破损，仍然可以被读取，因为二维码有纠错能力，纠错能力还分为4个级别，分别是：

* L级，恢复率7%
* M级，恢复率15%
* Q级，恢复率25%
* H级，恢复率30%

级别越高，纠错能力越强，但由于数据量会随之增加，二维码尺寸也会变大。  
纠错级别的恢复率，是指全部码字与可以纠错的码字的比例。例如，一共有100个码字（数据码），要对其中50个进行纠错，纠错级别为Q，则需要纠错码的个数等于50/0.25 - 100 = 100，也就是需要100个纠错码，加上数据码一共200个码字。  

码字是什么概念？1个码字等于8个码元。

5、360度方向读取  
<img src="https://github.com/wangmeijian/images/blob/master/erweimademimi/DCA8015A-35AE-44E3-AFE5-2473A60F5A7F.png?raw=true" width="320" align=center />  

二维码可以从任何角度读取

6、支持数据合并  
<img src="https://github.com/wangmeijian/images/blob/master/erweimademimi/01AD87AB-E7CB-4D16-8277-0F26E1816805.png?raw=true" width="320" align=center />  

一个二维码可以拆分为多个，多个也可以合并为一个  


## 攻击与防御
![](https://github.com/wangmeijian/images/blob/master/erweimademimi/F4D01B2C-05F6-46F4-9843-93ACED5D05D5.png?raw=true)  

2018年9月，出现了一些二维码，iPhone扫码后，立刻重启，这是因为二维码指向一个包含成千上万个div，设置了特定的样式，耗尽了iPhone的资源，而触发了iPhone的自我保护机制，重启了。这正是事物的两面性，二维码带来便利的同时，也存在一些安全问题。  





